import{b as le,u as ae,r as u,h as re,j as l,d as y,f as P,c as U}from"./index-NQW_x_Sn.js";import{i as z,M as se,T as ie}from"./TableSearch-D0PWM4AW.js";import{h as ne,c as oe}from"./tableExcel-h_9-hs2N.js";import{s as o}from"./TableSearch.module-DFltd_EQ.js";import{C as de}from"./CommonPopup-Dwp1i3fD.js";import{e as h}from"./errorMsgPopup-CX9GGfgq.js";import{m as ce}from"./msgPopup-B5uV-LHr.js";import"./DatePickerCommon-MvAA8I6u.js";import"./react-datepicker-D9fc_BLh.js";import"./index-BBx72Rax.js";const O=r=>({STATUS:[{value:"",label:"전체"},{value:"사용 중",label:"사용 중"},{value:"예약 가능",label:"예약 가능"},{value:"예약 완료",label:"예약 완료"}],GENDER:[{value:"Male",label:"남성"},{value:"Female",label:"여성"}],DURATION:[{value:1,label:"1개월"},{value:6,label:"6개월"},{value:12,label:"12개월"}],ROOM_TYPE:[{value:"1인실",label:"1인실"}]})[r]||[],ue=async(r,_,S)=>{try{const i={p_NAME:"",p_STATUS:"",p_FLOOR_ID:"",p_SECTION:"",p_DEBUG:"F"};console.log("Params before fetchData in fetchFieldOptions:",i);const N=await P(U,_,i);if(console.log("Response from fetchData in fetchFieldOptions:",N),!N.success||N.errCd!=="00")throw new Error(N.errMsg||`Failed to load ${r} options`);return Array.isArray(N.data)?N.data.map(m=>({value:m[r]||m,label:m[r]||m})):[]}catch(i){return console.error(`Failed to load ${r} options:`,i),h(`Failed to load ${r} options: ${i.message}`),[]}},Y={areas:[{type:"search",fields:[{id:"NAME",type:"text",row:1,label:"예약자 이름",labelVisible:!0,placeholder:"예약자 이름 입력",width:"200px",height:"30px",backgroundColor:"#ffffff",color:"#000000",enabled:!0},{id:"STATUS",type:"select",row:1,label:"상태",labelVisible:!0,options:[{value:"",label:"전체"},{value:"사용 중",label:"사용 중"},{value:"예약 가능",label:"예약 가능"},{value:"취소",label:"취소"}],width:"150px",height:"30px",backgroundColor:"#ffffff",color:"#000000",enabled:!0},{id:"FLOOR_ID",type:"text",row:2,label:"층 ID",labelVisible:!0,placeholder:"층 ID 입력 (예: 1F)",width:"150px",height:"30px",backgroundColor:"#ffffff",color:"#000000",enabled:!0},{id:"SECTION",type:"select",row:2,label:"섹션",labelVisible:!0,options:[{value:"",label:"전체"},{value:"A",label:"A"},{value:"B",label:"B"},{value:"C",label:"C"}],width:"150px",height:"30px",backgroundColor:"#ffffff",color:"#000000",enabled:!0}]},{type:"buttons",fields:[{id:"searchBtn",type:"button",row:1,label:"검색",eventType:"search",width:"80px",height:"30px",backgroundColor:"#00c4b4",color:"#ffffff",enabled:!0}]}]},F=[{id:"filterSelect",label:"",type:"select",options:[{value:"",label:"선택"},{value:"RESERVATION_ID",label:"예약 ID"},{value:"ROOM_ID",label:"호실 ID"},{value:"USER_ID",label:"사용자 ID"},{value:"ROOM_TYPE",label:"호실 유형"},{value:"NAME",label:"예약자 이름"},{value:"GENDER",label:"성별"},{value:"PHONE",label:"전화번호"},{value:"RESERVATION_DATE",label:"예약 날짜"},{value:"DURATION",label:"기간(개월)"},{value:"STATUS",label:"상태"},{value:"EMP_NO",label:"직원 번호"}],width:"auto"},{id:"filterText",label:"",type:"text",placeholder:"검색값을 입력하세요",width:"200px"}],be=()=>{const{user:r}=le(),_=ae(),S=u.useRef(null),i=u.useRef(null),N=u.useRef(!0),[m,k]=u.useState(z(Y.areas.find(t=>t.type==="search").fields)),[v,H]=u.useState(z(F)),[D,p]=u.useState([]),[g,A]=u.useState(!1),[b,I]=u.useState("initializing"),[$,x]=u.useState(!1),[d,f]=u.useState({RESERVATION_ID:"",ROOM_ID:"",USER_ID:(r==null?void 0:r.id)||"admin",ROOM_TYPE:"1인실",NAME:"",GENDER:"Male",PHONE:"",RESERVATION_DATE:new Date().toISOString().split("T")[0],DURATION:1,STATUS:"",EMP_NO:(r==null?void 0:r.emp_no)||"admin"}),[G,B]=u.useState(0),[j,L]=u.useState(!1),[C,W]=u.useState(O("ROOM_TYPE")),q=(t,e,n)=>({formatter:s=>{const a=document.createElement("button");return a.className=`btn btn-sm ${e}`,a.innerText=t,a.onclick=()=>n(s.getData()),a}}),T=(t,e)=>{const n=t.getRow().getData().RESERVATION_ID,s=t.getValue();setTimeout(()=>{p(a=>a.map(c=>{if(String(c.RESERVATION_ID)===String(n)){const E={...c,[e]:s};return E.is_deleted==="N"&&E.is_added==="N"&&(E.is_changed="Y"),E}return c})),i.current&&i.current.redraw()},0)},J=t=>{if(!t||!t.RESERVATION_ID){h("삭제할 데이터가 없습니다.");return}if(t.STATUS==="사용 중"){h("사용 중인 예약은 삭제할 수 없습니다.");return}const e=i.current;if(e){const n=e.getRows().find(s=>s.getData().RESERVATION_ID===t.RESERVATION_ID);n&&n.select()}setTimeout(()=>{t.is_added==="Y"?p(n=>n.filter(s=>s.RESERVATION_ID!==t.RESERVATION_ID)):p(n=>n.map(s=>s.RESERVATION_ID===t.RESERVATION_ID?{...s,is_deleted:"Y",is_changed:"N"}:s)),i.current&&i.current.redraw()},0)};u.useEffect(()=>{(!r||!re(r.auth,"reservationManage"))&&(console.log("Redirecting due to missing user or reservationManage permission"),_("/"))},[r,_]),u.useEffect(()=>{(async()=>{A(!0);try{const e=await ue("ROOM_TYPE",`${y.getServerUrl("reservation/reservation/list")}`,r);W(e.length>0?e:O("ROOM_TYPE"))}catch(e){console.error("Failed to load room types:",e)}finally{A(!1)}})()},[r]),u.useEffect(()=>((async()=>{if(!S.current){h("테이블 컨테이너를 초기화할 수 없습니다.");return}try{i.current=oe(S.current,[{frozen:!0,headerHozAlign:"center",hozAlign:"center",title:"작업",field:"actions",width:80,visible:!0,...q("삭제",`btn-danger ${o.deleteButton}`,J)},{frozen:!0,headerHozAlign:"center",hozAlign:"center",title:"작업대상",field:"applyTarget",sorter:"string",width:100,formatter:e=>{const n=e.getRow().getData();let s="",a="";if(n.is_deleted==="Y"?(s="삭제",a="is_deleted"):n.is_added==="Y"?(s="추가",a="is_added"):n.is_changed==="Y"&&(s="변경",a="is_changed"),!s)return"";const c=document.createElement("div");c.style.display="flex",c.style.alignItems="center",c.style.justifyContent="center",c.style.gap="5px";const E=document.createElement("input");E.type="checkbox",E.checked=n[a]==="Y",E.onclick=()=>{setTimeout(()=>{p(te=>te.map(M=>{if(M.RESERVATION_ID===n.RESERVATION_ID){const V={...M,[a]:E.checked?"Y":"N"};return a==="is_deleted"&&!E.checked&&(V.is_changed="N"),a==="is_added"&&!E.checked?null:V}return M}).filter(Boolean)),i.current&&i.current.redraw()},0)};const R=document.createElement("span");return R.innerText=s,c.appendChild(E),c.appendChild(R),c}},{headerHozAlign:"center",hozAlign:"center",title:"예약 ID",field:"RESERVATION_ID",sorter:"string",width:120,editable:!1},{headerHozAlign:"center",hozAlign:"left",title:"호실 ID",field:"ROOM_ID",sorter:"string",width:100,editor:"input",editable:!0,cellEdited:e=>T(e,"ROOM_ID")},{headerHozAlign:"center",hozAlign:"left",title:"호실 유형",field:"ROOM_TYPE",sorter:"string",width:100,editor:"list",editorParams:{values:C.map(e=>e.value)},editable:!0,cellEdited:e=>T(e,"ROOM_TYPE")},{headerHozAlign:"center",hozAlign:"left",title:"예약자 이름",field:"NAME",sorter:"string",width:120,editor:"input",editable:!0,cellEdited:e=>T(e,"NAME")},{headerHozAlign:"center",hozAlign:"center",title:"성별",field:"GENDER",sorter:"string",width:80,editor:"list",editorParams:{values:O("GENDER").map(e=>e.value)},editable:!0,cellEdited:e=>T(e,"GENDER")},{headerHozAlign:"center",hozAlign:"left",title:"전화번호",field:"PHONE",sorter:"string",width:120,editor:"input",editable:!0,cellEdited:e=>T(e,"PHONE")},{headerHozAlign:"center",hozAlign:"center",title:"예약 날짜",field:"RESERVATION_DATE",sorter:"string",width:120,editor:"input",editorParams:{type:"date"},editable:!0,cellEdited:e=>T(e,"RESERVATION_DATE")},{headerHozAlign:"center",hozAlign:"center",title:"기간(개월)",field:"DURATION",sorter:"number",width:100,editor:"list",editorParams:{values:O("DURATION").map(e=>e.value)},editable:!0,cellEdited:e=>T(e,"DURATION")},{headerHozAlign:"center",hozAlign:"center",title:"상태",field:"STATUS",sorter:"string",width:100,editor:"list",editorParams:{values:O("STATUS").map(e=>e.value)},editable:!0,cellEdited:e=>T(e,"STATUS")},{headerHozAlign:"center",hozAlign:"center",title:"직원 번호",field:"EMP_NO",sorter:"string",width:100,editor:"input",editable:!0,cellEdited:e=>T(e,"EMP_NO")},{headerHozAlign:"center",hozAlign:"center",title:"생성일시",field:"CREATED_AT",sorter:"string",width:150,editable:!1},{headerHozAlign:"center",hozAlign:"center",title:"수정일시",field:"UPDATED_AT",sorter:"string",width:150,editable:!1}],[],{editable:!0,rowFormatter:e=>{const n=e.getData(),s=e.getElement();s.classList.remove(o.deletedRow,o.addedRow,o.editedRow),n.is_deleted==="Y"?s.classList.add(o.deletedRow):n.is_added==="Y"?s.classList.add(o.addedRow):n.is_changed==="Y"&&s.classList.add(o.editedRow)}}),I("ready")}catch(e){I("error"),h("테이블 초기화에 실패했습니다: "+e.message)}})(),()=>{i.current&&(i.current.destroy(),i.current=null,I("initializing"))}),[]);const w=async()=>{var t,e;A(!0),L(!0);try{const n={p_NAME:m.NAME||"",p_STATUS:m.STATUS||"",p_FLOOR_ID:m.FLOOR_ID||"",p_SECTION:m.SECTION||"",p_DEBUG:"F"};console.log("Search params:",n);const s=await P(U,`${y.getServerUrl("reservation/reservation/list")}`,n);if(console.log("Search response:",s),!s.success){h(s.message||"예약 데이터를 가져오는 중 오류가 발생했습니다."),p([]);return}if(s.errMsg&&s.errCd!=="00"){h(s.errMsg),p([]);return}const a=Array.isArray(s.data)?s.data.map(c=>({...c,is_changed:"N",is_added:"N",is_deleted:"N"})):[];p(a)}catch(n){h(((e=(t=n.response)==null?void 0:t.data)==null?void 0:e.message)||"예약 데이터를 가져오는 중 오류가 발생했습니다."),p([])}finally{A(!1)}};u.useEffect(()=>{if(N.current){N.current=!1;return}const t=i.current;!t||b!=="ready"||g||(t.setData(D),j&&D.length===0&&!g?t.alert("검색 결과 없음","info"):(t.clearAlert(),B(t.getDataCount())))},[D,b,g,j]),u.useEffect(()=>{if(!i.current||b!=="ready"||g)return;const{filterSelect:t,filterText:e}=v;e&&t?i.current.setFilter(t,"like",e):e&&e!==""?i.current.setFilter([{field:"RESERVATION_ID",type:"like",value:e},{field:"ROOM_ID",type:"like",value:e},{field:"USER_ID",type:"like",value:e},{field:"ROOM_TYPE",type:"like",value:e},{field:"NAME",type:"like",value:e},{field:"GENDER",type:"like",value:e},{field:"PHONE",type:"like",value:e},{field:"RESERVATION_DATE",type:"like",value:e},{field:"DURATION",type:"like",value:e},{field:"STATUS",type:"like",value:e},{field:"EMP_NO",type:"like",value:e}],"or"):i.current.clearFilter()},[v,b,g]);const K=t=>{t==="search"&&w()},Q=()=>x(!0),X=()=>{if(!d.ROOM_ID||!d.NAME){h("호실 ID와 예약자 이름은 필수 입력 항목입니다.");return}const t={RESERVATION_ID:`TEMP_${Date.now()}`,...d,CREATED_AT:new Date().toISOString().slice(0,19).replace("T"," "),UPDATED_AT:new Date().toISOString().slice(0,19).replace("T"," "),is_deleted:"N",is_changed:"N",is_added:"Y"};p(e=>[t,...e]),x(!1),f({RESERVATION_ID:"",ROOM_ID:"",USER_ID:(r==null?void 0:r.id)||"admin",ROOM_TYPE:"1인실",NAME:"",GENDER:"Male",PHONE:"",RESERVATION_DATE:new Date().toISOString().split("T")[0],DURATION:1,STATUS:"",EMP_NO:(r==null?void 0:r.emp_no)||"admin"}),i.current&&i.current.redraw()},Z=()=>{x(!1),f({RESERVATION_ID:"",ROOM_ID:"",USER_ID:(r==null?void 0:r.id)||"admin",ROOM_TYPE:"1인실",NAME:"",GENDER:"Male",PHONE:"",RESERVATION_DATE:new Date().toISOString().split("T")[0],DURATION:1,STATUS:"",EMP_NO:(r==null?void 0:r.emp_no)||"admin"})},ee=async()=>{const t=D.filter(e=>e.is_deleted==="Y"||e.is_added==="Y"||e.is_changed==="Y");if(t.length===0){h("변경된 데이터가 없습니다.");return}A(!0);try{const e=t.map(async a=>{const c=a.is_deleted==="Y"?"D":a.is_added==="Y"?"I":"U",E={PGUBUN:c,PRESERVATION_ID:a.RESERVATION_ID,PROOM_ID:a.ROOM_ID||"",PUSER_ID:a.USER_ID||"admin",PROOM_TYPE:a.ROOM_TYPE||"1인실",PNAME:a.NAME||"",PGENDER:a.GENDER||"Male",PPHONE:a.PHONE||"",PRESERVATION_DATE:a.RESERVATION_DATE||new Date().toISOString().split("T")[0],PDURATION:a.DURATION||1,PSTATUS:a.STATUS||"",PEMP_NO:a.EMP_NO||(r==null?void 0:r.emp_no)||"admin",P_DEBUG:"F"};try{const R=await P(U,`${y.getServerUrl("reservation/reservation/save")}`,E);if(!R.success||R.errCd!=="00")throw new Error(R.errMsg||`Failed to process reservation ${a.RESERVATION_ID}`);return{...a,success:!0,message:R.errMsg||"성공"}}catch(R){return console.error(`Error processing ${c} for RESERVATION_ID: ${a.RESERVATION_ID}`,R),{...a,success:!1,error:R.message}}}),s=(await Promise.all(e)).filter(a=>!a.success);s.length>0?h(`일부 작업이 실패했습니다: ${s.map(a=>a.error).join(", ")}`):(ce("모든 변경사항이 성공적으로 저장되었습니다."),p(a=>a.map(c=>({...c,is_changed:"N",is_added:"N",is_deleted:"N"}))),await w())}catch(e){h(e.message||"저장 중 오류가 발생했습니다.")}finally{A(!1)}};return l.jsxs("div",{className:o.container,children:[l.jsx(se,{config:Y,filters:m,setFilters:k,onEvent:K}),l.jsx(ie,{filterFields:F,filters:v,setFilters:H,rowCount:G,onDownloadExcel:()=>ne(i.current,b,"예약관리.xlsx"),buttonStyles:o,children:l.jsxs("div",{className:o.btnGroupCustom,children:[l.jsx("button",{className:`${o.btn} text-bg-primary`,onClick:Q,children:"추가"}),l.jsx("button",{className:`${o.btn} text-bg-success`,onClick:ee,children:"저장"})]})}),l.jsxs("div",{className:o.tableWrapper,children:[b==="initializing"&&l.jsx("div",{children:"초기화 중..."}),g&&l.jsx("div",{children:"로딩 중..."}),l.jsx("div",{ref:S,className:o.tableSection,style:{visibility:g||b!=="ready"?"hidden":"visible"}})]}),l.jsxs(de,{show:$,onHide:Z,onConfirm:X,title:"예약 추가",children:[l.jsxs("div",{className:"mb-3",children:[l.jsx("label",{className:"form-label",children:"예약 ID"}),l.jsx("input",{type:"text",className:`form-control ${o.formControl}`,placeholder:"예약 ID 입력",value:d.RESERVATION_ID,onChange:t=>f({...d,RESERVATION_ID:t.target.value}),disabled:!0})]}),l.jsxs("div",{className:"mb-3",children:[l.jsx("label",{className:"form-label",children:"호실 ID"}),l.jsx("input",{type:"text",className:`form-control ${o.formControl}`,placeholder:"호실 ID 입력",value:d.ROOM_ID,onChange:t=>f({...d,ROOM_ID:t.target.value})})]}),l.jsxs("div",{className:"mb-3",children:[l.jsx("label",{className:"form-label",children:"호실 유형"}),l.jsxs("select",{className:`form-select ${o.formSelect}`,value:d.ROOM_TYPE,onChange:t=>f({...d,ROOM_TYPE:t.target.value}),children:[l.jsx("option",{value:"",children:"선택하세요"}),C.map(t=>l.jsx("option",{value:t.value,children:t.label},t.value))]})]}),l.jsxs("div",{className:"mb-3",children:[l.jsx("label",{className:"form-label",children:"예약자 이름"}),l.jsx("input",{type:"text",className:`form-control ${o.formControl}`,placeholder:"예약자 이름 입력",value:d.NAME,onChange:t=>f({...d,NAME:t.target.value})})]}),l.jsxs("div",{className:"mb-3",children:[l.jsx("label",{className:"form-label",children:"성별"}),l.jsx("select",{className:`form-select ${o.formSelect}`,value:d.GENDER,onChange:t=>f({...d,GENDER:t.target.value}),children:O("GENDER").map(t=>l.jsx("option",{value:t.value,children:t.label},t.value))})]}),l.jsxs("div",{className:"mb-3",children:[l.jsx("label",{className:"form-label",children:"전화번호"}),l.jsx("input",{type:"text",className:`form-control ${o.formControl}`,placeholder:"전화번호 입력 (예: 010-1234-5678)",value:d.PHONE,onChange:t=>f({...d,PHONE:t.target.value})})]}),l.jsxs("div",{className:"mb-3",children:[l.jsx("label",{className:"form-label",children:"예약 날짜"}),l.jsx("input",{type:"date",className:`form-control ${o.formControl}`,value:d.RESERVATION_DATE,onChange:t=>f({...d,RESERVATION_DATE:t.target.value})})]}),l.jsxs("div",{className:"mb-3",children:[l.jsx("label",{className:"form-label",children:"기간(개월)"}),l.jsx("select",{className:`form-select ${o.formSelect}`,value:d.DURATION,onChange:t=>f({...d,DURATION:parseInt(t.target.value)}),children:O("DURATION").map(t=>l.jsx("option",{value:t.value,children:t.label},t.value))})]}),l.jsxs("div",{className:"mb-3",children:[l.jsx("label",{className:"form-label",children:"상태"}),l.jsx("select",{className:`form-select ${o.formSelect}`,value:d.STATUS,onChange:t=>f({...d,STATUS:t.target.value}),children:O("STATUS").map(t=>l.jsx("option",{value:t.value,children:t.label},t.value))})]}),l.jsxs("div",{className:"mb-3",children:[l.jsx("label",{className:"form-label",children:"직원 번호"}),l.jsx("input",{type:"text",className:`form-control ${o.formControl}`,placeholder:"직원 번호 입력",value:d.EMP_NO,onChange:t=>f({...d,EMP_NO:t.target.value})})]})]})]})};export{be as default};
//# sourceMappingURL=ReservationManage-B4iUm_MH.js.map
